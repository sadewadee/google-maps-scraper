<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Maps Scraper</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/htmx/1.9.6/htmx.min.js"></script>
</head>
<body>
    <div class="app-container">
        <header>
            <h1>Google Maps Scraper</h1>
            <nav>
                <a href="/api/docs" target="_blank" rel="noopener noreferrer">API Documentation</a>
            </nav>
            <div class="topbar">
                <button class="button" onclick="openModal()">New Job</button>
            </div>
        </header>
        <main class="single-column">
            <!-- Make jobs immediately visible at the top -->
            <section class="jobs">
                <div class="jobs-toolbar">
                    <button class="button" onclick="filterCards('all')">All</button>
                    <button class="button" onclick="filterCards('pending')">Pending</button>
                    <button class="button" onclick="filterCards('working')">Working</button>
                    <button class="button" onclick="filterCards('ok')">Completed</button>
                    <button class="button" onclick="filterCards('failed')">Failed</button>
                </div>
                <div id="spinner" class="spinner"></div>
                <div id="job-list" class="job-card-grid" hx-get="/jobs" hx-trigger="load, every 10s">
                    <!-- Job cards will be inserted here by HTMX -->
                </div>
            </section>

            <!-- Compact dashboard below jobs for quick context -->
            <section class="dashboard">
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-title">Total Jobs</div>
                        <div class="stat-value" id="stat-total">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Jobs Completed</div>
                        <div class="stat-value" id="stat-completed">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Jobs/min</div>
                        <div class="stat-value" id="stat-rate">0.00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Last Activity</div>
                        <div class="stat-value" id="stat-last-activity">—</div>
                    </div>
                </div>
            </section>

            <!-- Import from Google Sheets -->
            <section class="import">
                <div class="section-header">
                    <h2>Import from Google Sheets</h2>
                    <p class="muted">Provide Spreadsheet ID and range. First column cells become job keywords.</p>
                </div>
                <form
                    hx-post="/api/v1/import/sheets"
                    hx-target="#job-list"
                    hx-swap="beforeend"
                    hx-indicator="#spinner"
                    hx-ext="json-enc"
                >
                    <fieldset>
                        <div class="form-group">
                            <label for="sheet_id">Spreadsheet ID</label>
                            <input type="text" id="sheet_id" name="sheet_id" placeholder="1AbcYourSheetID">
                        </div>
                        <div class="form-group">
                            <label for="range">Range</label>
                            <input type="text" id="range" name="range" value="Sheet1!A1:A1000">
                        </div>
                        <div class="form-group">
                            <label for="lang">Language</label>
                            <input type="text" id="lang" name="lang" value="en">
                        </div>
                        <div class="form-group">
                            <label for="depth">Depth</label>
                            <input type="number" id="depth" name="depth" value="10" step="1">
                        </div>
                        <div class="form-group">
                            <label for="max_time_seconds">Max Time (seconds)</label>
                            <input type="number" id="max_time_seconds" name="max_time_seconds" value="600" step="1">
                        </div>
                    </fieldset>
                    <div class="form-actions">
                        <button type="submit" class="button">Import</button>
                    </div>
                </form>
            </section>
            <!-- Minimal new job modal -->
            <div id="new-job-modal" class="modal" aria-hidden="true">
                <div class="modal-backdrop" onclick="closeModal()"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>New Job</h2>
                        <button class="modal-close" onclick="closeModal()">×</button>
                    </div>
                    <div id="error-container" class="error-message"></div>
                    <form
                        hx-post="/scrape"
                        hx-target="#job-list"
                        hx-swap="beforeend"
                        hx-indicator="#spinner"
                        hx-on::before-request="document.getElementById('error-container').innerHTML = ''"
                        hx-on::after-request="if(!event.detail.successful) document.getElementById('error-container').innerHTML = event.detail.xhr.responseText; else closeModal();"
                    >
                        <fieldset>
                            <div class="form-group">
                                <label for="name">Job Name</label>
                                <input type="text" id="name" name="name" value="{{.Name}}" placeholder="e.g., cafes in Jakarta">
                            </div>
                            <div class="form-group">
                                <label for="keywords">Keywords</label>
                                <textarea id="keywords" name="keywords" rows="4" placeholder="One per line">{{ .KeywordsString }}</textarea>
                            </div>
                            <div class="form-group">
                                <label for="lang">Language</label>
                                <input type="text" id="lang" name="lang" value="{{.Language}}" placeholder="en">
                            </div>
                        </fieldset>

                        <details class="expandable-section">
                            <summary>Location</summary>
                            <fieldset>
                                <div class="form-group">
                                    <label for="zoom">Zoom</label>
                                    <input type="number" id="zoom" name="zoom" value="{{.Zoom}}">
                                </div>
                                <div class="form-group">
                                    <label for="latitude">Latitude</label>
                                    <input type="number" step="0.000000000000001" id="latitude" name="latitude" value="{{.Lat}}">
                                </div>
                                <div class="form-group">
                                    <label for="longitude">Longitude</label>
                                    <input type="number" step="0.000000000000001" id="longitude" name="longitude" value="{{.Lon}}">
                                </div>
                            </fieldset>
                        </details>

                        <details class="expandable-section">
                            <summary>Advanced</summary>
                            <fieldset>
                                <div class="form-group">
                                    <label for="fastmode">Fast Mode</label>
                                    <input type="checkbox" id="fastmode" name="fastmode" {{if .FastMode}}checked{{end}}>
                                </div>
                                <div class="form-group">
                                    <label for="radius">Radius</label>
                                    <input type="number" id="radius" name="radius" value="{{.Radius}}">
                                </div>
                                <div class="form-group">
                                    <label for="depth">Depth</label>
                                    <input type="number" step="1" id="depth" name="depth" value="{{.Depth}}">
                                </div>
                                <div class="form-group checkbox">
                                    <input type="checkbox" id="email" name="email" {{if .Email}}checked{{end}}>
                                    <label for="email">Fetch Emails</label>
                                </div>
                                <div class="form-group">
                                    <label for="maxtime">Max query time</label>
                                    <input type="text" id="maxtime" name="maxtime" value="{{.MaxTime}}">
                                </div>
                            </fieldset>
                        </details>

                        <details class="expandable-section">
                            <summary>Proxies</summary>
                            <fieldset>
                                <div class="form-group">
                                    <label for="proxies">Proxies (one per line)</label>
                                    <textarea id="proxies" name="proxies" rows="4">{{.ProxiesString}}</textarea>
                                </div>
                            </fieldset>
                        </details>

                        <details class="expandable-section">
                            <summary>Adaptive Tiling</summary>
                            <fieldset>
                                <div class="form-group">
                                    <label for="bbox_min_lat">BBox Min Latitude</label>
                                    <input type="number" step="0.000000000000001" id="bbox_min_lat" name="bbox_min_lat" value="{{.BboxMinLat}}">
                                </div>
                                <div class="form-group">
                                    <label for="bbox_min_lon">BBox Min Longitude</label>
                                    <input type="number" step="0.000000000000001" id="bbox_min_lon" name="bbox_min_lon" value="{{.BboxMinLon}}">
                                </div>
                                <div class="form-group">
                                    <label for="bbox_max_lat">BBox Max Latitude</label>
                                    <input type="number" step="0.000000000000001" id="bbox_max_lat" name="bbox_max_lat" value="{{.BboxMaxLat}}">
                                </div>
                                <div class="form-group">
                                    <label for="bbox_max_lon">BBox Max Longitude</label>
                                    <input type="number" step="0.000000000000001" id="bbox_max_lon" name="bbox_max_lon" value="{{.BboxMaxLon}}">
                                </div>
                                <div class="form-group">
                                    <label for="split_threshold">Split Threshold</label>
                                    <input type="number" id="split_threshold" name="split_threshold" value="{{.SplitThreshold}}" placeholder="e.g. 90">
                                </div>
                                <div class="form-group">
                                    <label for="max_tiles">Max Tiles</label>
                                    <input type="number" id="max_tiles" name="max_tiles" value="{{.MaxTiles}}" placeholder="e.g. 250000">
                                </div>
                                <div class="form-group">
                                    <label for="tile_system">Tile System</label>
                                    <select id="tile_system" name="tile_system">
                                        <option value="s2" {{if eq .TileSystem "s2"}}selected{{end}}>S2</option>
                                        <option value="h3" {{if eq .TileSystem "h3"}}selected{{end}}>H3</option>
                                    </select>
                                </div>
                                <div class="form-group checkbox">
                                    <input type="checkbox" id="static_first" name="static_first" {{if .StaticFirst}}checked{{end}}>
                                    <label for="static_first">Static pb-first (browser fallback on failure)</label>
                                </div>
                            </fieldset>
                        </details>
                        <div class="modal-actions">
                            <button type="submit">Create Job</button>
                            <button type="button" class="button" onclick="closeModal()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

<script>
// Simple stats polling to update dashboard cards
async function updateStats() {
    try {
        const res = await fetch('/api/v1/stats');
        if (!res.ok) return;
        const data = await res.json();
        const total = document.getElementById('stat-total');
        const completed = document.getElementById('stat-completed');
        const rate = document.getElementById('stat-rate');
        const last = document.getElementById('stat-last-activity');
        if (total) total.textContent = data.total ?? 0;
        if (completed) completed.textContent = data.completed ?? 0;
        if (rate) rate.textContent = (data.jobs_per_min ?? 0).toFixed(2);
        if (last) last.textContent = data.last_activity ?? '—';
    } catch (e) {
        // noop
    }
}
updateStats();
setInterval(updateStats, 10000);

// Client-side filtering of job cards
function filterCards(status) {
    const cards = document.querySelectorAll('.job-card-grid .job-card');
    cards.forEach(card => {
        const statusEl = card.querySelector('.status-indicator');
        const current = statusEl ? (statusEl.textContent || '').trim().toLowerCase() : '';
        if (status === 'all' || current === status) {
            card.style.display = '';
        } else {
            card.style.display = 'none';
        }
    });
}

// Modal controls
function openModal() {
    const m = document.getElementById('new-job-modal');
    if (m) {
        m.setAttribute('aria-hidden', 'false');
        m.classList.add('open');
    }
}

function closeModal() {
    const m = document.getElementById('new-job-modal');
    if (m) {
        m.setAttribute('aria-hidden', 'true');
        m.classList.remove('open');
    }
}
</script>
</body>
</html>
